<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Galeria - Resenha do Chicão</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;600;800;900&family=Rock+Salt&display=swap" rel="stylesheet"/>
<style>
:root { --green: #3DA536; --orange: #F9A825; --chalk: #f3f3f3; --board: #0e0f11; }
body { margin: 0; color: var(--chalk); background: var(--board); font-family: "Montserrat", sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }

/* Textura de Lousa no Fundo */
body::before {
  content: "";
  position: fixed; inset: 0;
  background:
    radial-gradient(1200px 500px at -10% -20%, rgba(255,255,255,.04), transparent 60%),
    repeating-linear-gradient(0deg, rgba(255,255,255,.045) 0 1px, transparent 1px 5px);
  mix-blend-mode: overlay; opacity: 0.25; pointer-events: none; z-index: -1;
}

/* MENU NAV */
.main-nav { width: 100%; background: #5c3b22; padding: 10px 0; text-align: center; border-bottom: 4px solid #3e2716; position: fixed; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
.main-nav a { color: rgba(255,255,255,0.8); text-decoration: none; font-family: "Bebas Neue"; font-size: 18px; margin: 0 15px; padding: 5px 10px; transition: 0.3s; border-radius: 4px; }
.main-nav a:hover, .main-nav a.active { color: var(--orange); background: rgba(0,0,0,0.3); }

/* Conteúdo */
main { margin-top: 80px; width: 100%; max-width: 1000px; padding: 20px; text-align: center; z-index: 1; }
h1 { font-family: "Bebas Neue"; font-size: 48px; color: var(--orange); margin: 0 0 20px; text-shadow: 0 4px 0 rgba(0,0,0,0.5); }

/* --- ÁREA RESTRITA (Default: INVISÍVEL) --- */
#adminPanel { 
    display: none; /* O SEGREDO ESTÁ AQUI */
    background: rgba(61, 165, 54, 0.15); 
    border: 2px dashed var(--green); 
    padding: 20px; 
    border-radius: 12px; 
    margin-bottom: 30px; 
}

.btn-upload { background: var(--green); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: "Bebas Neue"; font-size: 20px; transition: 0.3s; }
.btn-upload:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(61, 165, 54, 0.4); }

.btn-logout { background: transparent; border: 1px solid #aaa; color: #aaa; padding: 5px 10px; cursor: pointer; margin-top: 10px; font-size: 12px; }
.btn-logout:hover { color: #fff; border-color: #fff; }

/* Grid de Fotos */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
.photo-card { position: relative; background: #fff; padding: 8px 8px 25px 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transform: rotate(-1deg); transition: 0.3s; }
.photo-card:nth-child(even) { transform: rotate(1.5deg); }
.photo-card:hover { transform: scale(1.05) rotate(0deg); z-index: 10; }
.photo-card img { width: 100%; height: 200px; object-fit: cover; display: block; background: #eee; }

/* Botão Excluir (Default: INVISÍVEL) */
.delete-btn { 
    display: none; /* O SEGREDO ESTÁ AQUI */
    position: absolute; top: -10px; right: -10px; 
    width: 30px; height: 30px; 
    background: #ff4444; color: white; 
    border-radius: 50%; border: 2px solid #fff; 
    font-weight: bold; cursor: pointer; 
    z-index: 20; justify-content:center; align-items:center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.delete-btn:hover { background: red; transform: scale(1.1); }
</style>
</head>
<body>

<nav class="main-nav">
  <a href="/">Home</a>
  <a href="https://whatsmenu.com.br/resenhadochicao" target="_blank">Cardápio</a>
  <a href="/galeria/" class="active">Galeria</a>
  <a href="/login/">Login</a>
</nav>

<main>
    <h1>Galeria de Fotos</h1>

    <div id="adminPanel">
        <h3 style="margin-top:0; font-family:'Bebas Neue'; color: #fff;">Gerenciar Galeria</h3>
        <input type="file" id="fileInput" accept="image/*" style="margin-bottom:10px; color:#fff;">
        <br>
        <button class="btn-upload" id="btnUpload">ENVIAR FOTO</button>
        <p id="uploadStatus" style="font-size: 12px; color:#ddd; margin-top: 5px;"></p>
        <button class="btn-logout" id="btnLogout">Sair (Logout)</button>
    </div>

    <div id="galleryContainer" class="gallery-grid">
        <p>Carregando...</p>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, listAll, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnTFb-qQEaoQ-bZ1be97KQfuARAOyiEu0",
      authDomain: "resenha-chicao.firebaseapp.com",
      projectId: "resenha-chicao",
      storageBucket: "resenha-chicao.firebasestorage.app",
      messagingSenderId: "529044459829",
      appId: "1:529044459829:web:a3c1485f390ff3f759fc7c",
      measurementId: "G-N67ZDJLXP6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const galleryRef = ref(storage, 'galeria_fotos');

    // 1. LÓGICA DE VISIBILIDADE
    onAuthStateChanged(auth, (user) => {
        const adminPanel = document.getElementById('adminPanel');
        if (user) {
            // Se tem usuário -> Mostra painel e botões de excluir
            adminPanel.style.display = 'block';
            document.querySelectorAll('.delete-btn').forEach(btn => btn.style.display = 'flex');
        } else {
            // Se não tem -> Esconde
            adminPanel.style.display = 'none';
        }
    });

    // 2. CARREGAR FOTOS
    function loadPhotos() {
        const container = document.getElementById('galleryContainer');
        listAll(galleryRef).then((res) => {
            container.innerHTML = '';
            if(res.items.length === 0) { container.innerHTML = '<p>Nenhuma foto na galeria.</p>'; return; }

            res.items.forEach((itemRef) => {
                getDownloadURL(itemRef).then((url) => {
                    const card = document.createElement('div');
                    card.className = 'photo-card';
                    // Cria o card com o botão X oculto (display: none no CSS)
                    card.innerHTML = `
                        <img src="${url}" alt="Foto Galeria" loading="lazy">
                        <button class="delete-btn" onclick="deletarFoto('${itemRef.fullPath}')">✕</button>
                    `;
                    container.appendChild(card);
                    
                    // Se já estiver logado ao carregar a foto, torna o botão visível
                    if(auth.currentUser) {
                        card.querySelector('.delete-btn').style.display = 'flex';
                    }
                });
            });
        }).catch(err => {
            console.error(err);
            container.innerHTML = '<p>Erro ao carregar fotos.</p>';
        });
    }

    // 3. UPLOAD
    document.getElementById('btnUpload').addEventListener('click', () => {
        const file = document.getElementById('fileInput').files[0];
        if(!file) return alert("Selecione um arquivo!");
        
        const status = document.getElementById('uploadStatus');
        status.innerText = "Enviando... Aguarde.";
        
        const fileName = Date.now() + '_' + file.name;
        const newFileRef = ref(storage, 'galeria_fotos/' + fileName);

        uploadBytes(newFileRef, file).then(() => {
            alert("Sucesso! Foto enviada.");
            status.innerText = "";
            document.getElementById('fileInput').value = "";
            loadPhotos();
        }).catch(err => { 
            alert("Erro no upload: " + err.message); 
            status.innerText = "Erro.";
        });
    });

    // 4. DELETAR (Global function)
    window.deletarFoto = (path) => { 
        if(!auth.currentUser) return; // Proteção extra
        if(confirm("Tem certeza que deseja apagar esta foto?")) {
            deleteObject(ref(storage, path))
                .then(() => { alert("Apagado!"); loadPhotos(); })
                .catch(err => alert("Erro: " + err.message));
        }
    }

    // 5. LOGOUT
    document.getElementById('btnLogout').addEventListener('click', () => { 
        signOut(auth).then(() => window.location.reload()); 
    });

    // Iniciar
    loadPhotos();
</script>
</body>
</html>
